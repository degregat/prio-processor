#!/bin/bash
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# This scripts generates data for testing the pipeline. The data is generated
# based on the data configuration file. Note that data under each of the buckets
# may be deleted due to rsync removing any file does not match.

set -euo pipefail
set -x

today=$(python3 -c "from datetime import datetime as dt; print(dt.utcnow().isoformat()[:10])")
: "${SUBMISSION_DATE:=${today}}"
: "${DATA_CONFIG?}"
: "${PUBLIC_KEY_HEX_INTERNAL?}"
: "${PUBLIC_KEY_HEX_EXTERNAL?}"
: "${BUCKET_INTERNAL_PRIVATE?}"
: "${BUCKET_EXTERNAL_PRIVATE?}"

function rsync_to_servers() {
    local src=$1
    local dest=$2

    # If we are working with the local filesystem, we need to create all parent
    # folders. Copying a temporary object will create recursively create all
    # parent folders on a file-system, and otherwise materialize the prefix in
    # an object store.
    touch _TEMP
    gsutil cp _TEMP "${dest}/_TEMP"

    # NOTE: this deletes files on the recieving end
    gsutil -m rsync -d -r "${src}/" "${dest}/"
    touch _SUCCESS
    gsutil cp _SUCCESS "${dest}"
}

function generate_dataset() {
    local submission_date=$1
    local output=$2
    local bootstrap
    bootstrap=$(mktemp -d -t bootstrap-XXX)
    source "${BASH_SOURCE%/*}/dataproc"
    SUBMODULE="spark" bootstrap "${bootstrap}"
    spark-submit \
        --py-files "${bootstrap}/prio_processor.egg" \
        "${bootstrap}/processor-spark.py" \
        generate-integration \
        --submission-date "${submission_date}" \
        --output "${output}"
}

function main() {
    "${BASH_SOURCE%/*}/authenticate"

    output="$(mktemp -d -t generate-XXX)"
    generate_dataset "${SUBMISSION_DATE}" "${output}"

    local generate_prefix="submission_date=${SUBMISSION_DATE}"
    local output_prefix="raw"

    rsync_to_servers \
        "${output}/${generate_prefix}/server_id=a" \
        "${BUCKET_INTERNAL_PRIVATE}/${output_prefix}"

    rsync_to_servers \
        "${output}/${generate_prefix}/server_id=b" \
        "${BUCKET_EXTERNAL_PRIVATE}/${output_prefix}"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
